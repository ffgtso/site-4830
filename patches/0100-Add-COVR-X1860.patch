From 48fc4d75d560c23a7c88521977cc87a2206b194c Mon Sep 17 00:00:00 2001
From: FFGT Admins <ffgt@basilisk.4830.org>
Date: Thu, 27 Jun 2024 01:12:52 +0200
Subject: [PATCH] Add D-Link COVR X1860 zo Gluon

---
 .../openwrt/0009-Add-D-Link-COVR-X1860.patch  | 90 +++++++++++++++++++
 1 file changed, 90 insertions(+)
 create mode 100644 patches/openwrt/0009-Add-D-Link-COVR-X1860.patch

diff --git a/patches/openwrt/0009-Add-D-Link-COVR-X1860.patch b/patches/openwrt/0009-Add-D-Link-COVR-X1860.patch
new file mode 100644
index 00000000..3a08da04
--- /dev/null
+++ b/patches/openwrt/0009-Add-D-Link-COVR-X1860.patch
@@ -0,0 +1,90 @@
+From 889415c17dea23cb8a6caf89416d0f93ce6a7e1c Mon Sep 17 00:00:00 2001
+From: FFGT Admins <ffgt@basilisk.4830.org>
+Date: Thu, 27 Jun 2024 01:08:14 +0200
+Subject: [PATCH] ramips: add support for D-Link COVR-X1860 A1
+
+---
+ target/linux/ramips/image/mt7621.mk                       | 8 ++++++++
+ .../linux/ramips/mt7621/base-files/etc/board.d/02_network | 8 ++++++++
+ .../base-files/etc/hotplug.d/ieee80211/10_fix_wifi_mac    | 7 +++++++
+ .../ramips/mt7621/base-files/lib/upgrade/platform.sh      | 1 +
+ 4 files changed, 24 insertions(+)
+
+diff --git a/target/linux/ramips/image/mt7621.mk b/target/linux/ramips/image/mt7621.mk
+index 5a72f5b843..01fed60da0 100644
+--- a/target/linux/ramips/image/mt7621.mk
++++ b/target/linux/ramips/image/mt7621.mk
+@@ -9,6 +9,14 @@ DEFAULT_SOC := mt7621
+ KERNEL_DTB += -d21
+ DEVICE_VARS += ELECOM_HWNAME LINKSYS_HWNAME
+ 
++define Build/append-dlink-covr-metadata
++	echo -ne '{"supported_devices": "$(1)", "firmware": "' > $@metadata.tmp
++	$(MKHASH) md5 "$@" | head -c32 >> $@metadata.tmp
++	echo '"}' >> $@metadata.tmp
++	fwtool -I $@metadata.tmp $@
++	rm $@metadata.tmp
++endef
++
+ define Build/arcadyan-trx
+ 	echo -ne "hsqs" > $@.hsqs
+ 	$(eval trx_magic=$(word 1,$(1)))
+diff --git a/target/linux/ramips/mt7621/base-files/etc/board.d/02_network b/target/linux/ramips/mt7621/base-files/etc/board.d/02_network
+index afd4a3710c..2d5fbe864f 100644
+--- a/target/linux/ramips/mt7621/base-files/etc/board.d/02_network
++++ b/target/linux/ramips/mt7621/base-files/etc/board.d/02_network
+@@ -105,6 +105,9 @@ ramips_setup_interfaces()
+ 	zyxel,nr7101)
+ 		ucidef_set_interfaces_lan_wan "lan" "wan"
+ 		;;
++	dlink,covr-x1860-a1)
++		ucidef_set_interfaces_lan_wan "ethernet" "internet"
++		;;
+ 	zyxel,wap6805)
+ 		ucidef_set_interface_lan "lan1 lan2 lan3 lan4"
+ 		ucidef_set_interface "qtn" ifname "eth1" protocol "static" ipaddr "1.1.1.1" netmask "255.255.255.0"
+@@ -147,6 +150,11 @@ ramips_setup_macs()
+ 		wan_mac="$(grep -m1 mac= "/dev/mtd${index}" | cut -d= -f2)"
+ 		lan_mac=$wan_mac
+ 		;;
++	dlink,covr-x1860-a1)
++		label_mac=$(mtd_get_mac_ascii config2 factory_mac)
++		wan_mac=$(macaddr_add "$label_mac" 3)
++		lan_mac=$label_mac
++		;;
+ 	dlink,dir-860l-b1)
+ 		lan_mac=$(mtd_get_mac_ascii factory lanmac)
+ 		wan_mac=$(mtd_get_mac_ascii factory wanmac)
+diff --git a/target/linux/ramips/mt7621/base-files/etc/hotplug.d/ieee80211/10_fix_wifi_mac b/target/linux/ramips/mt7621/base-files/etc/hotplug.d/ieee80211/10_fix_wifi_mac
+index d8c9512bb7..d7defda578 100644
+--- a/target/linux/ramips/mt7621/base-files/etc/hotplug.d/ieee80211/10_fix_wifi_mac
++++ b/target/linux/ramips/mt7621/base-files/etc/hotplug.d/ieee80211/10_fix_wifi_mac
+@@ -22,6 +22,13 @@ case "$board" in
+ 		hw_mac_addr="$(mtd_get_mac_binary factory 0x4)"
+ 		macaddr_add $hw_mac_addr "$PHYNBR" > /sys${DEVPATH}/macaddress
+ 		;;
++	dlink,covr-x1860-a1)
++		label_mac=$(mtd_get_mac_ascii config2 factory_mac)
++		[ "$PHYNBR" = "0" ] && \
++			macaddr_add $label_mac 1 > /sys${DEVPATH}/macaddress
++		[ "$PHYNBR" = "1" ] && \
++			macaddr_add $label_mac 2 > /sys${DEVPATH}/macaddress
++		;;
+ 	dlink,dap-x1860-a1)
+ 		hw_mac_addr="$(mtd_get_mac_binary factory 0x4)"
+ 		[ "$PHYNBR" = "0" ] && \
+diff --git a/target/linux/ramips/mt7621/base-files/lib/upgrade/platform.sh b/target/linux/ramips/mt7621/base-files/lib/upgrade/platform.sh
+index 4a6706e07a..7762357e8f 100755
+--- a/target/linux/ramips/mt7621/base-files/lib/upgrade/platform.sh
++++ b/target/linux/ramips/mt7621/base-files/lib/upgrade/platform.sh
+@@ -55,6 +55,7 @@ platform_do_upgrade() {
+ 	asus,rt-ac85p|\
+ 	asus,rt-ax53u|\
+ 	beeline,smartbox-flash|\
++	dlink,covr-x1860-a1|\
+ 	dlink,dap-x1860-a1|\
+ 	dlink,dir-1960-a1|\
+ 	dlink,dir-2640-a1|\
+-- 
+2.39.2
+
diff --git a/targets/ramips-mt7621 b/targets/ramips-mt7621
index 2338ffa5..7c0ae3b9 100644
--- a/targets/ramips-mt7621
+++ b/targets/ramips-mt7621
@@ -22,6 +22,12 @@ device('cudy-x6-v2', 'cudy_x6-v2', {

 -- D-Link

+device('d-link-covr-x1860-a1', 'dlink_covr-x1860-a1', {
+	extra_images = {
+		{'-squashfs-recovery', '-recovery', '.bin'}
+	},
+})
+
 device('d-link-dap-x1860-a1', 'dlink_dap-x1860-a1')

 device('d-link-dir-860l-b1', 'dlink_dir-860l-b1')
--
2.30.2

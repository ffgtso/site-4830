From 2d7bbdaf4850c6110aa225ec7ef11c12b0b37cfc Mon Sep 17 00:00:00 2001
From: wusel <wusel+src@uu.org>
Date: Sun, 16 Jun 2024 23:45:13 +0200
Subject: [PATCH] Allow setting HTMODE from site

---
 .../luasrc/lib/gluon/upgrade/200-wireless     | 30 +++++++++++++------
 1 file changed, 21 insertions(+), 9 deletions(-)

diff --git a/package/gluon-core/luasrc/lib/gluon/upgrade/200-wireless b/package/gluon-core/luasrc/lib/gluon/upgrade/200-wireless
index 9550a887..78aa4833 100755
--- a/package/gluon-core/luasrc/lib/gluon/upgrade/200-wireless
+++ b/package/gluon-core/luasrc/lib/gluon/upgrade/200-wireless
@@ -62,6 +62,9 @@ local function get_channel(radio, config)
 end
 
 local function get_htmode(radio)
+	local phy = wireless.find_phy(radio)
+	local site_htmode="HT20"
+
 	if wireless.preserve_channels(uci) then
 		return radio.htmode
 	end
@@ -73,16 +76,25 @@ local function get_htmode(radio)
 		end
 	end
 
-	local phy = wireless.find_phy(radio)
-	if iwinfo.nl80211.hwmodelist(phy).ax then
-		return 'HE20'
-	end
-
-	if iwinfo.nl80211.hwmodelist(phy).ac then
-		return 'VHT20'
+	if radio.band == '5g' then
+		site_htmode=site.wifi5.htmode('HT20')
+		if iwinfo.nl80211.hwmodelist(phy).ax then
+			site_htmode=site.wifi5.htmode('HE20')
+		end
+		if iwinfo.nl80211.hwmodelist(phy).ac then
+			site_htmode=site.wifi5.htmode('VHT20')
+		end
+	else
+		site_htmode=site.wifi2.htmode('HT20')
+		if iwinfo.nl80211.hwmodelist(phy).ax then
+			site_htmode=site.wifi2.htmode('HE20')
+		end
+		if iwinfo.nl80211.hwmodelist(phy).ac then
+			site_htmode=site.wifi2.htmode('VHT20')
+		end
 	end
-
-	return 'HT20'
+		
+	return site_htmode
 end
 
 local function is_disabled(name)
-- 
2.30.2

